using System.Data;

namespace Metro_Rail_DAL.DAL.Accounts.Report
{
    public  class R13003DAL: CommonDAL
    {
        public DataTable CompanyDetails(string partyType)
        {
            DataTable sql = new DataTable();
            sql = Query($"select VOUCHER_DETAILS_ID, AT13001.VOUCHER_NO,AT13001.ENTRY_DATE,AT13001.PARTY_TYPE_CODE,T12008.PARTY_TYPE_NAME,AT13002.ACCOUNT_HEADER_CODE, T12010.ACCOUNT_HEADER_NAME,VOU_DESCRIPTION,DEBIT,CREDIT from AT13002 JOIN AT13001 ON AT13002.VOUCHER_NO = AT13001.VOUCHER_NO JOIN T12008 ON AT13001.PARTY_TYPE_CODE = T12008.PARTY_TYPE_CODE JOIN T12010 ON AT13002.ACCOUNT_HEADER_CODE = T12010.ACCOUNT_HEADER_CODE WHERE AT13001.PARTY_TYPE_CODE = '{partyType}' AND AT13001.VAUCHER_TYPE_CODE = '101' AND AT13002.ACCOUNT_HEADER_CODE != '138' AND AT13002.ACCOUNT_HEADER_CODE != '137'  ORDER BY VOUCHER_DETAILS_ID ASC");

            return sql;
        }
        public DataTable SupplierUnderProject(string partyType)
        {
            DataTable sql = new DataTable();
            sql = Query($"select * from (select AT13001.PARTY_TYPE_CODE, T12008.PARTY_TYPE_NAME, AT13001.VAUCHER_TYPE_CODE, T12006.VAUCHER_TYPE_NAME, AT13001.VOUCHER_NO, AT13001.TRANSACTION_TYPE_CODE, T12007.TRANSACTION_TYPE_NAME , AT13002.ACCOUNT_HEADER_CODE, CONCAT (T12010.ACCOUNT_HEADER_NAME,' / ',T12012.PURPOSE_NAME )ACCOUNT_HEADER_NAME, AT13002.VOU_DESCRIPTION, AT13001.PARTY_CODE, T12009.PARTY_NAME, AT13002.CREDIT, AT13002.DEBIT, AT13001.VOUCHER_DATE from AT13001 JOIN AT13002 ON AT13001.VOUCHER_NO =AT13002.VOUCHER_NO JOIN T12006 ON AT13001.VAUCHER_TYPE_CODE =T12006.VAUCHER_TYPE_CODE JOIN T12007 ON AT13001.TRANSACTION_TYPE_CODE =T12007.TRANSACTION_TYPE_CODE JOIN T12008 ON AT13001.PARTY_TYPE_CODE =T12008.PARTY_TYPE_CODE JOIN T12009 ON AT13001.PARTY_CODE =T12009.PARTY_CODE JOIN T12010 ON AT13002.ACCOUNT_HEADER_CODE =T12010.ACCOUNT_HEADER_CODE JOIN T12012 ON AT13002.PURPOSE_CODE =T12012.PURPOSE_CODE where AT13001.PARTY_TYPE_CODE ='{partyType}' AND AT13001.VAUCHER_TYPE_CODE ='102' AND AT13002.CREDIT !=00 UNION select AT13001.PARTY_TYPE_CODE, T12008.PARTY_TYPE_NAME, AT13001.VAUCHER_TYPE_CODE, T12006.VAUCHER_TYPE_NAME, AT13001.VOUCHER_NO, AT13001.TRANSACTION_TYPE_CODE, T12007.TRANSACTION_TYPE_NAME , AT13002.ACCOUNT_HEADER_CODE, CONCAT (T12010.ACCOUNT_HEADER_NAME,' / ',T12012.PURPOSE_NAME )ACCOUNT_HEADER_NAME, AT13002.VOU_DESCRIPTION, AT13001.PARTY_CODE, T12009.PARTY_NAME, AT13002.CREDIT, AT13002.DEBIT, AT13001.VOUCHER_DATE from AT13001 JOIN AT13002 ON AT13001.VOUCHER_NO =AT13002.VOUCHER_NO JOIN T12006 ON AT13001.VAUCHER_TYPE_CODE =T12006.VAUCHER_TYPE_CODE JOIN T12007 ON AT13001.TRANSACTION_TYPE_CODE =T12007.TRANSACTION_TYPE_CODE JOIN T12008 ON AT13001.PARTY_TYPE_CODE =T12008.PARTY_TYPE_CODE JOIN T12009 ON AT13001.PARTY_CODE =T12009.PARTY_CODE JOIN T12010 ON AT13002.ACCOUNT_HEADER_CODE =T12010.ACCOUNT_HEADER_CODE JOIN T12012 ON AT13002.PURPOSE_CODE =T12012.PURPOSE_CODE where AT13001.PARTY_TYPE_CODE ='{partyType}' AND AT13001.VAUCHER_TYPE_CODE ='101' AND AT13002.DEBIT !=00)t_1 ORDER BY cast(t_1.VOUCHER_NO as numeric) ASC");

            return sql;
        }
        public DataTable SupplierStatement(string party)
        {
            DataTable sql = new DataTable();
            sql = Query($"select AT13001.PARTY_TYPE_CODE, T12008.PARTY_TYPE_NAME, AT13001.VOUCHER_NO,AT13001.PARTY_CODE, T12009.PARTY_NAME,AT13002.DEBIT, AT13001.VOUCHER_DATE from AT13001 JOIN AT13002 ON AT13001.VOUCHER_NO =AT13002.VOUCHER_NO JOIN T12009 ON AT13001.PARTY_CODE =T12009.PARTY_CODE JOIN T12008 ON AT13001.PARTY_TYPE_CODE =T12008.PARTY_TYPE_CODE where AT13001.PARTY_CODE ='{party}' AND AT13001.VAUCHER_TYPE_CODE ='101' AND AT13002.DEBIT !=00");

            return sql;
        }

        public DataTable AllCompanySummary()
        {
            DataTable sql = new DataTable();
            sql = Query($"select PARTY_TYPE_CODE, PARTY_TYPE_NAME, sum(DEBIT) TOTAL_DEBIT, SUM(CREDIT)TOTAL_CREDIT, (sum(DEBIT)-SUM(CREDIT))TOTAL_BALANCE from ( select AT13001.PARTY_TYPE_CODE, T12008.PARTY_TYPE_NAME, AT13002.VOUCHER_NO, AT13002.ACCOUNT_HEADER_CODE, T12010.ACCOUNT_HEADER_NAME, AT13002.DEBIT, AT13002.CREDIT from AT13002 JOIN AT13001 ON AT13002.VOUCHER_NO =AT13001.VOUCHER_NO JOIN T12008 ON AT13001.PARTY_TYPE_CODE =T12008.PARTY_TYPE_CODE JOIN T12010 ON AT13002.ACCOUNT_HEADER_CODE =T12010.ACCOUNT_HEADER_CODE where AT13001.VAUCHER_TYPE_CODE = '101' AND AT13002.ACCOUNT_HEADER_CODE != '138' AND AT13002.ACCOUNT_HEADER_CODE != '137')t_1 group by PARTY_TYPE_CODE, PARTY_TYPE_NAME");

            return sql;
        }

        public DataTable IndividualSuprDetlsUnderProj(string partyType,string party)
        {
            DataTable sql = new DataTable();
            sql = Query($"select t_1.PARTY_TYPE_CODE,t_1.T_PROJECT_NAME, t_1.T_PARTY_CODE,t_1.T_PARTY_LIMIT, t_2.VOUCHER_NO , t_2.TRANSACTION_TYPE_NAME, t_2.VOU_DESCRIPTION, t_2.PARTY_NAME, t_2.DEBIT, t_2.VOUCHER_DATE from ( select PARTY_TYPE_CODE,T_PROJECT_NAME, AT13006.T_PARTY_CODE, AT13006.T_PARTY_LIMIT from AT13005 JOIN AT13006 ON AT13005.T_PROJECT_ID = AT13006.T_PROJECT_ID where AT13006.T_PARTY_CODE='{party}' AND PARTY_TYPE_CODE ='{partyType}' )t_1 LEFT JOIN ( select AT13001.PARTY_TYPE_CODE, AT13001.VOUCHER_NO, T12008.PARTY_TYPE_NAME, AT13001.TRANSACTION_TYPE_CODE, T12007.TRANSACTION_TYPE_NAME, AT13002.VOU_DESCRIPTION, AT13001.PARTY_CODE, T12009.PARTY_NAME, AT13002.DEBIT, AT13001.VOUCHER_DATE from AT13001 JOIN AT13002 ON AT13001.VOUCHER_NO =AT13002.VOUCHER_NO JOIN T12009 ON AT13001.PARTY_CODE =T12009.PARTY_CODE JOIN T12007 ON AT13001.TRANSACTION_TYPE_CODE =T12007.TRANSACTION_TYPE_CODE JOIN T12008 ON AT13001.PARTY_TYPE_CODE =T12008.PARTY_TYPE_CODE where AT13001.PARTY_CODE ='{party}' AND AT13001.VAUCHER_TYPE_CODE ='101' AND AT13001.PARTY_TYPE_CODE ='{partyType}' AND AT13002.DEBIT !=00)t_2 ON t_1.PARTY_TYPE_CODE =t_2.PARTY_TYPE_CODE");

            return sql;
        }
        public DataTable IndividualSuprAllProjSummary(string party)
        {
            DataTable sql = new DataTable();
            sql = Query($"select t_1.PARTY_TYPE_CODE, t_1.T_PARTY_CODE , t_1.T_PROJECT_NAME,t_1.PARTY_NAME, t_1.T_PARTY_LIMIT, case when t_2.T_PAY IS NULL then 00 else t_2.T_PAY end DEBIT, (t_1.T_PARTY_LIMIT-(case when t_2.T_PAY IS NULL then 00 else t_2.T_PAY end))DUE from ( select AT13005.T_PROJECT_ID, AT13005.PARTY_TYPE_CODE, T_PROJECT_NAME, T12009.PARTY_NAME, AT13006.T_PARTY_CODE, AT13006.T_PARTY_LIMIT from AT13005 JOIN AT13006 ON AT13005.T_PROJECT_ID =AT13006.T_PROJECT_ID JOIN T12009 ON AT13006.T_PARTY_CODE =T12009.PARTY_CODE AND AT13006.T_PARTY_CODE='{party}' )t_1 LEFT JOIN ( select SUM( AT13001.TOTAL_CREDIT) T_PAY, AT13001.PARTY_CODE, AT13005.PARTY_TYPE_CODE from AT13001 JOIN AT13005 ON AT13001.PARTY_TYPE_CODE =AT13005.PARTY_TYPE_CODE where VAUCHER_TYPE_CODE='101' AND AT13001.PARTY_CODE='{party}' GROUP BY AT13001.PARTY_CODE,AT13005.PARTY_TYPE_CODE )t_2 ON t_1.T_PARTY_CODE =t_2.PARTY_CODE AND t_1.PARTY_TYPE_CODE =t_2.PARTY_TYPE_CODE"); 
            //sql = Query($"select t_1.PARTY_TYPE_CODE,T_PROJECT_NAME,T_PARTY_CODE,T_PARTY_LIMIT,PARTY_NAME,DEBIT,T_PARTY_LIMIT-DEBIT DUE from ( select PARTY_TYPE_CODE,T_PROJECT_NAME, AT13006.T_PARTY_CODE, AT13006.T_PARTY_LIMIT from AT13005 JOIN AT13006 ON AT13005.T_PROJECT_ID = AT13006.T_PROJECT_ID where AT13006.T_PARTY_CODE='{party}' )t_1 JOIN ( select AT13001.PARTY_TYPE_CODE, AT13001.PARTY_CODE, T12009.PARTY_NAME, SUM (AT13002.DEBIT)DEBIT from AT13001 JOIN AT13002 ON AT13001.VOUCHER_NO =AT13002.VOUCHER_NO JOIN T12009 ON AT13001.PARTY_CODE =T12009.PARTY_CODE JOIN T12007 ON AT13001.TRANSACTION_TYPE_CODE =T12007.TRANSACTION_TYPE_CODE JOIN T12008 ON AT13001.PARTY_TYPE_CODE =T12008.PARTY_TYPE_CODE where AT13001.PARTY_CODE ='{party}' AND AT13001.VAUCHER_TYPE_CODE ='101' AND AT13002.DEBIT !=00 GROUP BY AT13001.PARTY_TYPE_CODE, T12008.PARTY_TYPE_NAME, AT13001.PARTY_CODE, T12009.PARTY_NAME)t_2 ON t_1.PARTY_TYPE_CODE =t_2.PARTY_TYPE_CODE");

            return sql;
        }
        public DataTable CompanyCashFlowReport(string partyType, string fDate, string tDate)
        {
            DataTable sql = new DataTable();
            sql = Query($@";with Table_Tamp as (
                select VOUCHER_DETAILS_ID, 
                AT13001.VOUCHER_NO,
                AT13001.ENTRY_DATE,
                AT13001.VOUCHER_DATE,
                AT13001.PARTY_TYPE_CODE,
                T12008.PARTY_TYPE_NAME,
                AT13002.ACCOUNT_HEADER_CODE, 
                T12010.ACCOUNT_HEADER_NAME,
                VOU_DESCRIPTION,
                DEBIT,
                CREDIT ,
                (DEBIT - CREDIT )BALANCE
                from AT13002 
                JOIN AT13001 ON AT13002.VOUCHER_NO = AT13001.VOUCHER_NO 
                JOIN T12008 ON AT13001.PARTY_TYPE_CODE = T12008.PARTY_TYPE_CODE 
                JOIN T12010 ON AT13002.ACCOUNT_HEADER_CODE = T12010.ACCOUNT_HEADER_CODE 
                WHERE AT13001.PARTY_TYPE_CODE = '{partyType}'
                AND AT13001.VAUCHER_TYPE_CODE = '101' 
                AND AT13002.ACCOUNT_HEADER_CODE != '138' 
                AND AT13002.ACCOUNT_HEADER_CODE != '137' 
                 )
                select 
                00 RowNumber,
                PARTY_TYPE_NAME,
                00 VOUCHER_DETAILS_ID, 
                '00'VOUCHER_DATE, 
                '00'ENTRY_DATE,
                '00' ACCOUNT_HEADER_CODE, 
                'An Opening' ACCOUNT_HEADER_NAME,
                'Opening balance' VOU_DESCRIPTION,
                '00' DEBIT,
                '00'CREDIT,
                (Balance-DEBIT)+CREDIT AS BALANCE 
                from ( 
                SELECT ROW_NUMBER() OVER (Order by t2.VOUCHER_DETAILS_ID) AS RowNumber,
                t2.PARTY_TYPE_NAME,
                t2.VOUCHER_DETAILS_ID,
                t2.VOUCHER_DATE,
                t2.ENTRY_DATE,
                t2.ACCOUNT_HEADER_CODE, 
                t2.ACCOUNT_HEADER_NAME, 
                t2.VOU_DESCRIPTION, 
                t2.DEBIT,
                t2.CREDIT, 
                SUM(t1.BALANCE) AS Balance
                from Table_Tamp t1 
                INNER JOIN Table_Tamp t2 ON t1.VOUCHER_DETAILS_ID <= t2.VOUCHER_DETAILS_ID 
                WHERE CONVERT(date, t2.ENTRY_DATE ,104) 
                BETWEEN CONVERT(date, '{fDate}' ,104) 
                AND CONVERT(date, '{tDate}' ,104) 
                GROUP BY 
                t2.VOUCHER_DETAILS_ID,
                t2.PARTY_TYPE_NAME,
                t2.VOUCHER_DATE,
                t2.ENTRY_DATE, 
                t2.VOU_DESCRIPTION,
                t2.CREDIT,
                t2.ACCOUNT_HEADER_CODE,
                t2.ACCOUNT_HEADER_NAME, 
                t2.DEBIT)t_3
                where RowNumber=1 
                UNION select ROW_NUMBER() OVER (Order by t2.VOUCHER_DETAILS_ID) AS RowNumber,
                t2.PARTY_TYPE_NAME,
                t2.VOUCHER_DETAILS_ID, t2.VOUCHER_DATE, t2.ENTRY_DATE,
                t2.ACCOUNT_HEADER_CODE, t2.ACCOUNT_HEADER_NAME,
                t2.VOU_DESCRIPTION, t2.DEBIT, t2.CREDIT,
                SUM(t1.BALANCE) AS Balance from Table_Tamp t1 
                INNER JOIN Table_Tamp t2 ON t1.VOUCHER_DETAILS_ID <= t2.VOUCHER_DETAILS_ID 
                WHERE CONVERT(date, t2.ENTRY_DATE ,104)
                BETWEEN CONVERT(date, '{fDate}' ,104)
                AND CONVERT(date, '{tDate}' ,104) 
                GROUP BY t2.VOUCHER_DETAILS_ID,
                t2.PARTY_TYPE_NAME,
                t2.VOUCHER_NO,
                t2.VOUCHER_DATE,t2.ENTRY_DATE,
                t2.VOU_DESCRIPTION, t2.CREDIT,
                t2.ACCOUNT_HEADER_CODE, 
                t2.ACCOUNT_HEADER_NAME, 
                t2.DEBIT");
            return sql;
        }

    }
}
